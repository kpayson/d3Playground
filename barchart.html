<!DOCTYPE html>
<html>
<head>
    <title>Timeline Bar Chart Control</title>
    <style>
        /* Add custom styles here */
    </style>
</head>
<body>
    <svg id="chart"></svg>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>

    </style>
    <script>
        const chartParams = {
            svg: {
                width: 800,
                height: 200,
                margin: { top: 20, right: 30, bottom: 30, left: 50 },
            },
            row: {
                height: 41,
                evenRowFillColor: "#ebe9e6",
                oddRowFillColor: "#d4d2cf",
                padding: {
                    top: 8,
                    right: 12,
                    bottom: 8,
                    left: 12,
                },
            },
            bar: {
                height: 24,
                colors: {
                    '0': 'green',
                    '1': 'yellow',
                    '2': 'red'
                },
                hoverColors: {
                    '0': 'lightgreen',
                    '1': 'lightyellow',
                    '2': 'lightred'
                }
            }
        };

        const data = [
            {
                roomName: "Room 1",
                statusPoints: [
                    { time: "2021-01-01T09:00:00", status: 0 },
                    { time: "2021-01-01T12:00:00", status: 1 },
                    { time: "2021-01-01T15:00:00", status: 2 },
                ],
            },
            {
                roomName: "Room 2",
                statusPoints: [
                    { time: "2021-01-01T09:00:00", status: 2 },
                    { time: "2021-01-01T12:00:00", status: 1 },
                    { time: "2021-01-01T15:00:00", status: 0 },
                ],
            },
            // Add more room data objects...
        ];

        const dataPrep = (points, minTime, maxTime) => {
            points.sort((a, b) => new Date(a.time) - new Date(b.time));

            if(points[0] !== minTime) {
                points.unshift({time: minTime, status: points[0].status})
            }
            if(points[points.length - 1] !== maxTime) {
                points.push({time: maxTime, status: points[points.length - 1].status})
            }
            for(let i=0; i<points.length-1; i++) {
                points[i]["duration"] = new Date(points[i+1].time) - new Date(points[i].time);
            }
            points.pop();
        }

        const minTime = d3.min(data.flatMap((d) => d.statusPoints), (d) => new Date(d.time));
        const maxTime = d3.max(data.flatMap((d) => d.statusPoints), (d) => new Date(d.time));
        const timeRange = maxTime - minTime;

        for(const room of data) {
            dataPrep(room.statusPoints, minTime, maxTime);
        }

        const margin = { top: 20, right: 30, bottom: 30, left: 50 };
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3
            .select("#chart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const scalePercent = (x) => width * x / timeRange;
        const xScale = d3.scaleTime().range([0, width]);
        const yScale = d3.scaleBand().range([0, height]);

        const xAxis = d3.axisBottom(xScale);
        const yAxis = d3.axisLeft(yScale);

        const colorScale = d3
            .scaleOrdinal()
            .domain([0, 1, 2])
            .range(["green", "yellow", "red"]);

        const rowFill0 = "#ebe9e6";
        const rowFill1 = "#d4d2cf";
        const rowHeight = 41;
        const barHeight = 24;

        xScale.domain(
            d3.extent(data.flatMap((d) => d.statusPoints), (d) => new Date(d.time))
        );
        
        yScale.domain(data.map((d) => d.roomName));

        svg.append("g").attr("transform", `translate(0,${height})`).call(xAxis);
        svg.append("g").call(yAxis);

        // svg
        //     .append("g")
            // .append("rect")
            //     .attr("x", 0)
            //     .attr("y", yScale("Room 1")+ 2 * margin.top + margin.bottom) // + 2 * margin.top + margin.bottom
            //     .attr("width", 400)
            //     .attr("height", 20)
            //     .attr("fill", "green")

            // .append("rect")
            //     .attr("x", 0)
            //     .attr("y", yScale("Room 2")+ 2 * margin.top + margin.bottom)
            //     .attr("width", 400)
            //     .attr("height", 20)
            //     .attr("fill", "red")
            // .attr("pointer-events", "all")
            // .on("mousemove", (event) => {
            //     const [x, y] = d3.pointer(event);
            //     const date = xScale.invert(x);
            //     const room = yScale.domain()[Math.floor(y / yScale.step())];

            //     const status = data.find((d) => d.roomName === room).statusPoints.find(
            //         (d) => new Date(d.time) <= date && new Date(d.time) + 1000 > date
            //     ).status;

            //     console.log(`Room: ${room}, Status: ${status}`);
            // });


        // for(const barGroup of data) {
        //     svg.append("g")
        //         .attr("class", "bar-group")
        //         .attr("transform", (d) => `translate(0,${yScale(d.roomName) + 2 * margin.top + margin.bottom})`)
        // }

        svg
            .selectAll(".bar-group")
            .data(data)
            .enter()
                .append("g")
                    .attr("class", "bar-group")
                    .attr("transform", (d) => `translate(0,${yScale(d.roomName) + 2 * margin.top + margin.bottom})`)
                    .append("rect")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("width", 400)
                        .attr("height", 20)
                        .attr("fill", "green")
                        .attr("pointer-events", "all")
                        .on("mousemove", (event) => {
                            const [x, y] = d3.pointer(event);
                            const date = xScale.invert(x);
                            const room = yScale.domain()[Math.floor(y / yScale.step())];

                            const status = data.find((d) => d.roomName === room).statusPoints.find(
                                (d) => new Date(d.time) <= date && new Date(d.time) + 1000 > date
                            ).status;

                            console.log(`Room: ${room}, Status: ${status}`);
                        })
                    .selectAll(".bar")
                    .data((d) => d.statusPoints)
                    .enter()
                    .append("rect")
                        .attr("class", "bar")
                        .attr("x", (p) => xScale(new Date(p.time)))  //(d) => xScale(new Date(d.time))
                        .attr("y", 0)
                        .attr("width", (p) => scalePercent(p.duration))
                        .attr("height", 20)
                        .attr("fill", (p) => colorScale(p.status))


                        // <rect x="0" y="0" width="806" height="40.992" stroke="none" stroke-width="0" fill="#ebe9e6"></rect>
            // .enter()
            // .append("rect")
            // .attr("x", 0)
            // .attr("y", d=> yScale(d.roomName)+ 2 * margin.top + margin.bottom) // + 2 * margin.top + margin.bottom
            // .attr("width", 400)
            // .attr("height", 20)
            // .attr("fill", "green")

            // .append("g")
            // .attr("class", "bar-group")
            // .attr("transform", (d) => `translate(0,${yScale(d.roomName) + yScale.bandwidth() / 4})`)
            // .selectAll(".bar")
            // .data((d) => d.statusPoints)
            // .enter()
            // .append("rect")
            // .attr("class", "bar")
            // .attr("x", (d) => xScale(new Date(d.time)))
            // .attr("y", 0)
            // .attr("width", (d) => xScale(new Date(d.time) + 1000) - xScale(new Date(d.time)))
            // .attr("height", yScale.bandwidth() / 2)
            // .attr("fill", (d) => color)
    </script>
</body>
</html>




